// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// SQLite no soporta enums, usamos Strings
// Rol: "CLIENTE" | "RESPONSABLE"
// Turno: "ALMUERZO" | "CENA"
// Zona: "FRENTE" | "GALERIA" | "SALON"
// EstadoReserva: "RESERVADA" | "CANCELADA_POR_CLIENTE" | "CANCELADA_POR_RESTAURANTE"

// Modelo de Usuario
model Usuario {
  id                 Int      @id @default(autoincrement())
  nombre             String
  apellido           String
  telefono           String
  email              String   @unique
  passwordHash       String
  rol                String   @default("CLIENTE")
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  reservas Reserva[]

  @@map("usuarios")
}

// Modelo de Reserva
model Reserva {
  id                      Int      @id @default(autoincrement())
  clienteId               Int
  fecha                   DateTime // Solo se usa la fecha (día)
  turno                   String // "ALMUERZO" | "CENA"
  zona                    String // "FRENTE" | "GALERIA" | "SALON"
  cantidadPersonas        Int
  observaciones           String?
  estado                  String   @default("RESERVADA")
  fechaCreacion           DateTime @default(now())
  fechaUltimaModificacion DateTime @updatedAt

  // Relaciones
  cliente     Usuario             @relation(fields: [clienteId], references: [id])
  comentarios ComentarioReserva[]
  cuenta      Cuenta? // Relación inversa con cuenta

  @@map("reservas")
}

// Modelo de Comentario de Reserva
model ComentarioReserva {
  id              Int      @id @default(autoincrement())
  reservaId       Int
  textoComentario String
  fechaComentario DateTime @default(now())

  // Relaciones
  reserva Reserva @relation(fields: [reservaId], references: [id])

  @@map("comentarios_reserva")
}

// Modelo de Parámetros de Capacidad del Restaurante
model ParametrosCapacidadRestaurante {
  id                     Int @id @default(autoincrement())
  capacidadFrente        Int @default(30)
  capacidadGaleria       Int @default(200)
  capacidadSalon         Int @default(500)
  anticipacionMaximaDias Int @default(30)
  // Días de apertura: martes(2) a sábado(6) - se maneja en lógica de negocio

  @@map("parametros_capacidad")
}

// ===== MODELOS PARA GESTIÓN RESTAURANTE =====

// Modelo de Mozo/Empleado
model Mozo {
  id                 Int      @id @default(autoincrement())
  nombre             String
  apellido           String
  telefono           String
  dni                String   @unique
  activo             Boolean  @default(true)
  fechaIngreso       DateTime @default(now())
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  cuentas        Cuenta[]
  historialMesas HistorialMesa[]

  @@map("mozos")
}

// Modelo de Mesa
model Mesa {
  id                 Int      @id @default(autoincrement())
  numero             Int      @unique
  capacidad          Int      @default(4)
  zona               String // "FRENTE" | "GALERIA" | "SALON"
  activa             Boolean  @default(true)
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  cuentas        Cuenta[]
  historialMesas HistorialMesa[]

  @@map("mesas")
}

// Modelo de Categoría de Producto
model CategoriaProducto {
  id                 Int      @id @default(autoincrement())
  nombre             String   @unique
  activa             Boolean  @default(true)
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  productos Producto[]

  @@map("categorias_productos")
}

// Modelo de Producto del Menú
model Producto {
  id                 Int      @id @default(autoincrement())
  nombre             String
  descripcion        String?
  precio             Float
  categoriaId        Int
  disponible         Boolean  @default(true)
  tiempoPreparacion  Int? // en minutos
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  categoria   CategoriaProducto @relation(fields: [categoriaId], references: [id])
  itemsPedido ItemPedido[]

  @@map("productos")
}

// Modelo de Cuenta/Pedido
model Cuenta {
  id                 Int       @id @default(autoincrement())
  mesaId             Int
  mozoId             Int
  reservaId          Int?      @unique // Relación opcional con reserva
  numeroClientes     Int       @default(1)
  fechaApertura      DateTime  @default(now())
  fechaCierre        DateTime?
  subtotal           Float     @default(0)
  propina            Float     @default(0)
  total              Float     @default(0)
  estado             String    @default("ABIERTA") // "ABIERTA" | "CERRADA" | "CANCELADA"
  observaciones      String?
  fechaCreacion      DateTime  @default(now())
  fechaActualizacion DateTime  @updatedAt

  // Relaciones
  mesa    Mesa         @relation(fields: [mesaId], references: [id])
  mozo    Mozo         @relation(fields: [mozoId], references: [id])
  reserva Reserva?     @relation(fields: [reservaId], references: [id])
  items   ItemPedido[]

  @@map("cuentas")
}

// Modelo de Item de Pedido
model ItemPedido {
  id                 Int       @id @default(autoincrement())
  cuentaId           Int
  productoId         Int
  cantidad           Int       @default(1)
  precioUnitario     Float
  precioTotal        Float
  observaciones      String?
  estado             String    @default("PENDIENTE") // "PENDIENTE" | "EN_COCINA" | "LISTO" | "ENTREGADO" | "CANCELADO"
  fechaPedido        DateTime  @default(now())
  fechaEntrega       DateTime?
  fechaActualizacion DateTime  @updatedAt

  // Relaciones
  cuenta   Cuenta   @relation(fields: [cuentaId], references: [id])
  producto Producto @relation(fields: [productoId], references: [id])

  @@map("items_pedido")
}

// Modelo para Historial de Mesas (auditoría)
model HistorialMesa {
  id              Int       @id @default(autoincrement())
  mesaId          Int
  mozoId          Int
  fechaAsignacion DateTime  @default(now())
  fechaLiberacion DateTime?
  observaciones   String?

  // Relaciones
  mesa Mesa @relation(fields: [mesaId], references: [id])
  mozo Mozo @relation(fields: [mozoId], references: [id])

  @@map("historial_mesas")
}
